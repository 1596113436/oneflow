add_library(
    oneflow_user_op_kernel

    data/coco_data_reader.cpp
    data/coco_dataset.cpp
    data/coco_parser.cpp
    data/gpt_dataset.cpp

    kernels/acc_kernel.cpp
    kernels/add_n_kernel.cpp
    kernels/amp_white_identity_kernel.cpp
    kernels/argmax_kernel.cpp
    kernels/arg_sort_kernel.cpp
    kernels/arg_where_kernel.cpp
    kernels/arg_where_kernel_util.cpp
    kernels/assign_if_kernel.cpp
    kernels/assign_kernel.cpp
    kernels/batch_gather_kernel.cpp
    kernels/bernoulli_kernel.cpp
    kernels/bias_add_kernel.cpp
    kernels/broadcast_div_grad_kernel.cpp
    kernels/broadcast_like_kernel.cpp
    kernels/cast_kernel.cpp
    kernels/cast_to_static_shape_kernel.cpp
    kernels/categorical_ordinal_encode_kernel.cpp
    kernels/categorical_ordinal_encode_kernel_util.cpp
    kernels/clip_by_value_kernel.cpp
    kernels/coco_reader_kernel.cpp
    kernels/combined_margin_loss_kernel.cpp
    kernels/concat_kernel.cpp
    kernels/constant_kernel.cpp
    kernels/conv_cudnn_kernels.cpp
    kernels/conv_kernels.cpp
    kernels/copy_kernel.cpp
    kernels/count_not_finite_kernel.cpp
    kernels/ctc_loss_kernel.cpp
    kernels/ctc_loss_kernel_util.cpp
    kernels/deconv_cudnn_kernel.cpp
    kernels/diag_kernel.cpp
    kernels/dim_gather_kernels.cpp
    kernels/dim_gather_kernel_util.cpp
    kernels/dropout_kernel.cpp
    kernels/dynamic_loss_scale_schedule_kernel.cpp
    kernels/elementwise_maximum_minimum_kernel.cpp
    kernels/elu_kernel.cpp
    kernels/empty_kernel.cpp
    kernels/expand_dims_kernel.cpp
    kernels/expand_kernel.cpp
    kernels/fake_quantization_kernel.cpp
    kernels/flatten_kernel.cpp
    kernels/fused_cast_scale_kernel.cpp
    kernels/gather_kernel.cpp
    kernels/gelu_kernel.cpp
    kernels/generate_random_batch_permutation_indices_kernel.cpp
    kernels/gpt_data_loader_kernel.cpp
    kernels/hardsigmoid_kernel.cpp
    kernels/hardswish_kernel.cpp
    kernels/hardtanh_kernel.cpp
    kernels/identity_kernel.cpp
    kernels/image_batch_align_kernel.cpp
    kernels/image_decode_kernel.cpp
    kernels/image_object_preprocess_kernels.cpp
    kernels/image_preprocess_kernels.cpp
    kernels/image_resize_kernels.cpp
    kernels/image_target_resize_kernel.cpp
    kernels/indexed_slices_reduce_sum_kernel.cpp
    kernels/indexed_slices_reduce_sum_kernel_util.cpp
    kernels/in_top_k_kernel.cpp
    kernels/in_top_k_kernel_util.cpp
    kernels/l1_l2_regularize_gradient_kernel.cpp
    kernels/l1_l2_regularize_gradient_kernel_util.cpp
    kernels/l2_normalize_kernel.cpp
    kernels/layer_norm_cpu_kernel.cpp
    kernels/leaky_relu_kernel.cpp
    kernels/math_binary_broadcast_kernels.cpp
    kernels/math_binary_elementwise_kernel.cpp
    kernels/math_unary_elementwise_kernel.cpp
    kernels/matmul_kernels.cpp
    kernels/min_max_observer_kernel.cpp
    kernels/model_update_kernels.cpp
    kernels/model_update_kernel_util.cpp
    kernels/moving_average_min_max_observer_kernel.cpp
    kernels/multiply_kernel.cpp
    kernels/nccl_logical_2d_sbp_kernels.cpp
    kernels/nccl_logical_kernels.cpp
    kernels/nd_index_slice_kernels.cpp
    kernels/nop_kernel.cpp
    kernels/ofrecord_decoder_kernels.cpp
    kernels/ofrecord_image_classification_reader_kernel.cpp
    kernels/ofrecord_reader_kernel.cpp
    kernels/one_hot_kernel.cpp
    kernels/onerec_decoder_kernels.cpp
    kernels/onerec_reader_kernel.cpp
    kernels/ones_like_kernel.cpp
    kernels/pack_kernel.cpp
    kernels/pad2d_kernels.cpp
    kernels/pad2d_kernels_util.cpp
    kernels/pad_kernel.cpp
    kernels/pool_cpu_kernel.cpp
    kernels/pool_gpu_kernel.cpp
    kernels/prelu_kernel.cpp
    kernels/random_crop_kernel_state.cpp
    kernels/random_mask_generator.cpp
    kernels/random_seed_util.cpp
    kernels/range_kernel.cpp
    kernels/range_kernel_util.cpp
    kernels/reduce_kernel.cpp
    kernels/reduce_like_kernels.cpp
    kernels/relu_kernel.cpp
    kernels/repeat_kernel.cpp
    kernels/reshape_kernel.cpp
    kernels/reshape_like_kernel.cpp
    kernels/same_padding_kernel.cpp
    kernels/scalar_add_kernel.cpp
    kernels/scalar_by_tensor_kernel.cpp
    kernels/scalar_mul_kernel.cpp
    kernels/scalar_pow_kernel.cpp
    kernels/sigmoid_cross_entropy_kernel.cpp
    kernels/sigmoid_kernel.cpp
    kernels/slice_kernel.cpp
    kernels/slice_util.cpp
    kernels/smooth_l1_loss_kernel.cpp
    kernels/softmax_cross_entropy_kernel.cpp
    kernels/softmax_kernel.cpp
    kernels/softmax_kernel_util.cpp
    kernels/sort_kernel.cpp
    kernels/sparse_cross_entropy_kernel.cpp
    kernels/sparse_cross_entropy_kernel_util.cpp
    kernels/sparse_softmax_cross_entropy_kernel.cpp
    kernels/split_like_kernel.cpp
    kernels/square_sum_kernel.cpp
    kernels/squeeze_kernel.cpp
    kernels/ssp_variable_proxy_kernel.cpp
    kernels/stateful_local_opkernel.cpp
    kernels/tensor_buffer_kernels.cpp
    kernels/test_kernels.cpp
    kernels/top_k_kernel.cpp
    kernels/transpose_kernel.cpp
    kernels/tril_kernel.cpp
    kernels/tuple_identity_kernel.cpp
    kernels/two_stage_reduce_kernel.cpp
    kernels/two_stage_reduce_kernel_util.cpp
    kernels/unique_kernel_util.cpp
    kernels/unique_with_counts_kernel.cpp
    kernels/unpack_kernel.cpp
    kernels/unsorted_batch_segment_sum_kernel.cpp
    kernels/unsorted_segment_sum_kernel.cpp
    kernels/unsorted_segment_sum_kernel_util.cpp
    kernels/where_kernel.cpp
    kernels/where_kernel_util.cpp
    kernels/zero_like_kernel.cpp

    ops/acc_op.cpp
    ops/add_n_op.cpp
    ops/amp_white_identity_op.cpp
    ops/argmax_op.cpp
    ops/arg_sort_op.cpp
    ops/arg_where_op.cpp
    ops/assign_op.cpp
    ops/batch_gather_op.cpp
    ops/bernoulli_op.cpp
    ops/bias_add_op.cpp
    ops/broadcast_div_grad_op.cpp
    ops/broadcast_like_op.cpp
    ops/broadcast_ops_grad.cpp
    ops/buffer_op.cpp
    ops/cast_like_op.cpp
    ops/cast_op.cpp
    ops/cast_to_static_shape_op.cpp
    ops/cast_to_tick_op.cpp
    ops/categorical_ordinal_encode_op.cpp
    ops/clip_by_value_op.cpp
    ops/coco_reader_op.cpp
    ops/combined_margin_loss_op.cpp
    ops/concat_op.cpp
    ops/constant_op.cpp
    ops/conv_op.cpp
    ops/copy_op.cpp
    ops/count_not_finite_op.cpp
    ops/ctc_loss_op.cpp
    ops/deconv_op.cpp
    ops/diag_op.cpp
    ops/dim_gather_op.cpp
    ops/dropout_op.cpp
    ops/dynamic_loss_scale_schedule_op.cpp
    ops/eager_nccl_ops.cpp
    ops/elementwise_maximum_minimum_ops.cpp
    ops/elu_op.cpp
    ops/empty_op.cpp
    ops/expand_dims_op.cpp
    ops/expand_op.cpp
    ops/fake_quantization_op.cpp
    ops/flatten_op.cpp
    ops/fused_bias_add_op.cpp
    ops/fused_cast_scale_op.cpp
    ops/fused_scale_tril_softmax_mask_scale_op.cpp
    ops/fused_self_attention_query_mul_key_and_value_ops.cpp
    ops/gather_op.cpp
    ops/gelu_op.cpp
    ops/generate_random_batch_permutation_indices_op.cpp
    ops/gpt_data_loader_op.cpp
    ops/hardsigmoid_op.cpp
    ops/hardswish_op.cpp
    ops/hardtanh_op.cpp
    ops/hierarchical_parallel_cast_op.cpp
    ops/identity_op.cpp
    ops/image_batch_align_op.cpp
    ops/image_decode_op.cpp
    ops/image_object_preprocess_ops.cpp
    ops/image_preprocess_ops.cpp
    ops/image_resize_ops.cpp
    ops/image_target_resize_op.cpp
    ops/indexed_slices_reduce_sum_op.cpp
    ops/in_top_k_op.cpp
    ops/l1_l2_regularize_gradient_op.cpp
    ops/l2_normalize_op.cpp
    ops/layer_norm_op.cpp
    ops/leaky_relu_op.cpp
    ops/math_binary_broadcast_ops.cpp
    ops/math_binary_elementwise_ops.cpp
    ops/math_unary_elementwise_op.cpp
    ops/matmul_op.cpp
    ops/min_max_observer_op.cpp
    ops/model_update_ops.cpp
    ops/moving_average_min_max_observer_op.cpp
    ops/multiply_op.cpp
    ops/nccl_logical_2d_sbp_ops.cpp
    ops/nccl_logical_ops.cpp
    ops/nd_index_slice_ops.cpp
    ops/nn_util.cpp
    ops/normalization_op.cpp
    ops/nvtx_range_op.cpp
    ops/ofrecord_decoder_ops.cpp
    ops/ofrecord_image_classification_reader_op.cpp
    ops/ofrecord_reader_op.cpp
    ops/one_hot_op.cpp
    ops/onerec_decoder_op.cpp
    ops/onerec_reader_op.cpp
    ops/ones_like_op.cpp
    ops/pack_op.cpp
    ops/pad2d_ops.cpp
    ops/pad_op.cpp
    ops/parallel_cast_op.cpp
    ops/partial_fc_sample_op.cpp
    ops/pool_op.cpp
    ops/prelu_op.cpp
    ops/range_op.cpp
    ops/reduce_like_ops.cpp
    ops/reduce_ops.cpp
    ops/relu_op.cpp
    ops/repeat_op.cpp
    ops/reshape_like_op.cpp
    ops/reshape_op.cpp
    ops/reshape_user_op_util.cpp
    ops/same_padding_op.cpp
    ops/scalar_add_op.cpp
    ops/scalar_by_tensor_op.cpp
    ops/scalar_mul_op.cpp
    ops/scalar_pow_op.cpp
    ops/sigmoid_cross_entropy_op.cpp
    ops/sigmoid_op.cpp
    ops/slice_op.cpp
    ops/smooth_l1_loss_op.cpp
    ops/softmax_cross_entropy_op.cpp
    ops/softmax_op.cpp
    ops/sort_op.cpp
    ops/sparse_cross_entropy_op.cpp
    ops/sparse_softmax_cross_entropy_op.cpp
    ops/split_like_op.cpp
    ops/square_sum_op.cpp
    ops/squeeze_op.cpp
    ops/ssp_variable_proxy_op.cpp
    ops/summary_ops.cpp
    ops/tensor_buffer_ops.cpp
    ops/test_ops.cpp
    ops/top_k_op.cpp
    ops/transpose_ops.cpp
    ops/tril_op.cpp
    ops/tuple_identity_op.cpp
    ops/two_stage_reduce_ops.cpp
    ops/unique_with_counts_op.cpp
    ops/unpack_op.cpp
    ops/unsorted_batch_segment_sum_op.cpp
    ops/unsorted_segment_sum_op.cpp
    ops/upsample_op.cpp
    ops/where_op.cpp
    ops/zero_like_op.cpp

    image/image_util.cpp
    image/random_crop_generator.cpp

    utils/pool_util.cpp
)

add_library(
    oneflow_user_summary

    kernels/summary_kernels.cpp
    summary/events_writer.cpp
    summary/event_writer_helper.cpp
    summary/histogram.cpp
    summary/plan_to_physical_graph.cpp
)
target_link_libraries(oneflow_user_summary ${OPENCV_STATIC_LIBRARIES})

set(ONEFLOW_USER_LIBS oneflow_user_op_kernel)

if (BUILD_CUDA)
    cuda_add_library(
        oneflow_user_cuda_kernel

        kernels/add_n_kernel.cu
        kernels/argmax_kernel.cu
        kernels/arg_sort_kernel.cu
        kernels/arg_where_kernel_util.cu
        kernels/assign_if_kernel.cu
        kernels/bias_add_kernel.cu
        kernels/categorical_ordinal_encode_kernel_util.cu
        kernels/clip_by_value_kernel.cu
        kernels/combined_margin_loss_kernel.cu
        kernels/conv_cudnn_kernels.cpp
        kernels/count_not_finite_kernel.cu
        kernels/ctc_loss_kernel_util.cu
        kernels/deconv_cudnn_kernel.cpp
        kernels/diag_kernel.cu
        kernels/dim_gather_kernel_util.cu
        kernels/dropout_kernel.cu
        kernels/dynamic_loss_scale_schedule_kernel.cu
        kernels/eager_nccl_kernels.cu
        kernels/elementwise_maximum_minimum_kernel.cu
        kernels/elu_kernel.cu
        kernels/expand_kernel.cu
        kernels/fake_quantization_kernel.cu
        kernels/fused_bias_add_kernel.cu
        kernels/fused_cast_scale_kernel.cu
        kernels/fused_self_attention_query_mul_key_and_value_kernel.cu
        kernels/fused_tril_scale_softmax_mask_scale_kernel.cu
        kernels/gelu_kernel.cu
        kernels/generate_random_batch_permutation_indices_kernel.cu
        kernels/hardsigmoid_kernel.cu
        kernels/hardswish_kernel.cu
        kernels/hardtanh_kernel.cu
        kernels/heap_selection_top_k_kernel.cu
        kernels/image_preprocess_kernels.cu
        kernels/in_top_k_kernel_util.cu
        kernels/l1_l2_regularize_gradient_kernel_util.cu
        kernels/l2_normalize_kernel.cu
        kernels/layer_norm_gpu_kernel.cu
        kernels/leaky_relu_kernel.cu
        kernels/math_binary_elementwise_kernel.cu
        kernels/math_unary_elementwise_kernel.cu
        kernels/min_max_observer_kernel.cu
        kernels/model_update_kernel_util.cu
        kernels/moving_average_min_max_observer_kernel.cu
        kernels/nd_index_slice_kernels.cu
        kernels/normalization_kernel.cu
        kernels/nvtx_range_kernel.cu
        kernels/one_hot_kernel.cu
        kernels/pad2d_kernels_util.cu
        kernels/partial_fc_sample_kernel.cu
        kernels/prelu_kernel.cu
        kernels/radix_sort.cuh
        kernels/radix_sort_top_k_kernel.cu
        kernels/random_mask_generator.cu
        kernels/range_kernel_util.cu
        kernels/scalar_pow_kernel.cu
        kernels/sigmoid_cross_entropy_kernel.cu
        kernels/slice_util.cu
        kernels/smooth_l1_loss_kernel.cu
        kernels/softmax_cross_entropy_kernel.cu
        kernels/softmax_kernel_util.cu
        kernels/sort_kernel.cu
        kernels/sparse_cross_entropy_kernel_util.cu
        kernels/sparse_softmax_cross_entropy_kernel.cu
        kernels/tril_kernel.cu
        kernels/two_stage_reduce_kernel_util.cu
        kernels/unique_kernel_util.cu
        kernels/unsorted_segment_sum_kernel_util.cu
        kernels/upsample_kernel.cu
        kernels/where_kernel_util.cu
    )
    cuda_add_library(
        oneflow_softmax_cuda_kernel
        kernels/softmax_kernel.cu
    )
    target_link_libraries(oneflow_user_cuda_kernel ${CUDA_LIBRARIES})
    target_link_libraries(oneflow_softmax_cuda_kernel ${CUDA_LIBRARIES})
    list(APPEND ONEFLOW_USER_LIBS oneflow_user_cuda_kernel)
    list(APPEND ONEFLOW_USER_LIBS oneflow_softmax_cuda_kernel)
endif()

set(ONEFLOW_USER_LIBS ${ONEFLOW_USER_LIBS} PARENT_SCOPE)

add_dependencies(of_protoobj make_pyproto_dir ${PROTOBUF_COPY_TARGETS})
if (BUILD_SHARED_LIBS)
  get_filename_component(GLOG_RPATH "${GLOG_STATIC_LIBRARIES}" DIRECTORY)
  get_filename_component(PB_RPATH "${PROTOBUF_LIBRARY_DIR}" DIRECTORY)
  target_link_libraries(oneflow_user_op_kernel of_protoobj of_cfgobj "${GLOG_STATIC_LIBRARIES}")
  set_target_properties(oneflow_user_op_kernel PROPERTIES INSTALL_RPATH "${GLOG_RPATH} ${PB_RPATH}")
endif()
